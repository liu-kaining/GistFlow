<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GistFlow - 管理界面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .glass-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #d1d5db;
        }
        
        .stat-card .stat-value {
            color: #1f2937;
        }
        
        .stat-card .stat-label {
            color: #6b7280;
        }
        
        .nav-btn {
            transition: all 0.2s;
            position: relative;
        }
        
        .nav-btn.active {
            color: #2563eb;
        }
        
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #2563eb;
        }
        
        .btn-primary {
            background: #2563eb;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .code-editor {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .config-required {
            border-left: 3px solid #dc2626;
            background: #fef2f2;
        }
        
        .config-optional {
            border-left: 3px solid #9ca3af;
            background: #f9fafb;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-running {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-stopped {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .table-row {
            transition: background-color 0.15s;
        }
        
        .table-row:hover {
            background-color: #f9fafb;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.875rem 1.25rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.15s ease-out;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            padding: 0;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.15s ease-out;
            border: 1px solid #e5e7eb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-body {
            padding: 1.25rem 1.25rem;
        }
        
        .modal-footer {
            padding: 0.75rem 1.25rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-1">GistFlow</h1>
                    <p class="text-gray-500 text-sm">Newsletter Knowledge Pipeline</p>
                </div>
                <div id="connection-status" class="flex items-center space-x-2 text-gray-600 text-sm">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span>已连接</span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="mb-6 glass-card rounded-lg px-2">
            <div class="flex space-x-1">
                <button onclick="showPage('dashboard')" class="nav-btn px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 active">
                    仪表盘
                </button>
                <button onclick="showPage('prompts')" class="nav-btn px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                    Prompt 管理
                </button>
                <button onclick="showPage('config')" class="nav-btn px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                    配置
                </button>
                <button onclick="showPage('tasks')" class="nav-btn px-6 py-3 text-sm font-medium text-gray-600 hover:text-gray-900">
                    任务
                </button>
            </div>
        </nav>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="stat-card rounded-lg p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="stat-label text-sm font-medium">任务状态</h3>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p id="task-status" class="stat-value text-2xl font-bold">加载中...</p>
                </div>
                <div class="stat-card rounded-lg p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="stat-label text-sm font-medium">已处理邮件</h3>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <p id="total-processed" class="stat-value text-2xl font-bold">-</p>
                </div>
                <div class="stat-card rounded-lg p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="stat-label text-sm font-medium">平均评分</h3>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                    </div>
                    <p id="avg-score" class="stat-value text-2xl font-bold">-</p>
                </div>
                <div class="stat-card rounded-lg p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="stat-label text-sm font-medium">垃圾邮件</h3>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <p id="total-spam" class="stat-value text-2xl font-bold">-</p>
                </div>
                <div class="stat-card rounded-lg p-5">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="stat-label text-sm font-medium">错误数</h3>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p id="total-errors" class="stat-value text-2xl font-bold">-</p>
                </div>
            </div>

            <div class="glass-card rounded-lg p-5 mb-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">调度器状态</h3>
                <div id="scheduler-status-info" class="mb-4 text-sm text-gray-600">
                    <p>加载中...</p>
                </div>
            </div>

            <div class="glass-card rounded-lg p-5">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">快速操作</h3>
                <div class="flex flex-wrap gap-3">
                    <button onclick="runTask()" class="btn-primary text-white px-5 py-2 rounded-lg font-medium text-sm">
                        手动执行
                    </button>
                    <button id="start-scheduler-btn" onclick="startScheduler()" class="bg-green-600 text-white px-5 py-2 rounded-lg font-medium text-sm hover:bg-green-700 transition hidden">
                        启动调度
                    </button>
                    <button id="pause-task-btn" onclick="pauseTask()" class="bg-yellow-600 text-white px-5 py-2 rounded-lg font-medium text-sm hover:bg-yellow-700 transition hidden">
                        暂停调度
                    </button>
                    <button id="resume-task-btn" onclick="resumeTask()" class="bg-green-600 text-white px-5 py-2 rounded-lg font-medium text-sm hover:bg-green-700 transition hidden">
                        恢复调度
                    </button>
                    <button onclick="stopTask()" class="bg-red-600 text-white px-5 py-2 rounded-lg font-medium text-sm hover:bg-red-700 transition">
                        停止调度
                    </button>
                    <button onclick="loadStats()" class="bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-medium text-sm hover:bg-gray-200 transition">
                        刷新统计
                    </button>
                </div>
            </div>
        </div>

        <!-- Prompts Page -->
        <div id="prompts" class="page hidden">
            <div class="glass-card rounded-lg p-5 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">System Prompt</h2>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">核心配置</span>
                </div>
                <textarea id="system-prompt" class="w-full h-64 p-4 border border-gray-300 rounded-lg code-editor focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="System Prompt 内容..."></textarea>
            </div>

            <div class="glass-card rounded-lg p-5 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">User Prompt Template</h2>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">核心配置</span>
                </div>
                <textarea id="user-prompt" class="w-full h-48 p-4 border border-gray-300 rounded-lg code-editor focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="User Prompt Template 内容..."></textarea>
            </div>

            <div class="flex space-x-3 mb-4">
                <button onclick="loadPrompts()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-200 transition">
                    加载当前
                </button>
                <button onclick="savePrompts()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium text-sm hover:bg-green-700 transition">
                    保存并重载
                </button>
                <button onclick="reloadPrompts()" class="btn-primary text-white px-4 py-2 rounded-lg font-medium text-sm">
                    重新加载
                </button>
            </div>

            <div class="glass-card rounded-lg p-5 mb-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">测试 Prompt</h2>
                <textarea id="test-content" class="w-full h-32 p-4 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="输入测试内容..."></textarea>
                <button onclick="testPrompt()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium text-sm hover:bg-blue-700 transition">
                    测试
                </button>
                <div id="test-result" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                    <pre class="text-xs text-gray-700 overflow-x-auto"></pre>
                </div>
            </div>

            <div class="glass-card rounded-lg p-5">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Prompt 历史</h2>
                <div class="mb-4 flex items-center space-x-3">
                    <select id="prompt-history-type" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">全部</option>
                        <option value="system">System Prompt</option>
                        <option value="user">User Prompt</option>
                    </select>
                    <button onclick="loadPromptHistory()" class="btn-primary text-white px-4 py-2 rounded-lg font-medium text-sm">
                        查看历史
                    </button>
                </div>
                <div id="prompt-history-list" class="space-y-3">
                    <p class="text-gray-500 text-sm">点击"查看历史"加载</p>
                </div>
            </div>
        </div>

        <!-- Config Page -->
        <div id="config" class="page hidden">
            <div class="glass-card rounded-lg p-5">
                <div class="flex justify-between items-center mb-5">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">配置管理</h2>
                        <p class="text-sm text-gray-500 mt-1">修改配置后需要重启服务才能生效</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="loadConfig()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium transition">
                            刷新
                        </button>
                        <button onclick="saveConfig()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium transition">
                            保存配置
                        </button>
                    </div>
                </div>
                
                <div id="config-form" class="space-y-5">
                    <div class="loading mx-auto"></div>
                </div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasks" class="page hidden">
            <div class="glass-card rounded-lg p-5 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">执行详情</h2>
                    <button onclick="loadLastRun()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium transition">
                        刷新
                    </button>
                </div>
                <div id="last-run-detail" class="text-sm">
                    <p class="text-gray-500">加载中...</p>
                </div>
            </div>

            <div class="glass-card rounded-lg p-5 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">任务历史</h2>
                    <button onclick="loadTaskHistory()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium transition">
                        刷新
                    </button>
                </div>
                <div id="task-history" class="text-gray-500 text-sm">
                    <div class="loading mx-auto"></div>
                </div>
            </div>
            
            <div class="glass-card rounded-lg p-5">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">失败任务</h2>
                <div id="failed-tasks" class="text-gray-500 text-sm">
                    <div class="loading mx-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title">确认操作</h3>
            </div>
            <div class="modal-body">
                <p class="text-gray-600" id="modal-message">确定要执行此操作吗？</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal(false)" class="px-4 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button onclick="closeModal(true)" class="px-4 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors" id="modal-confirm-btn">
                    确认
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        let confirmCallback = null;
        
        function showConfirm(title, message, confirmText = '确认', onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-btn').textContent = confirmText;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = onConfirm;
        }
        
        function closeModal(confirmed) {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
        }
        
        // Close modal on overlay click
        document.getElementById('confirm-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(false);
            }
        });

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 ${colors[type]} rounded-full"></div>
                    <span class="text-sm font-medium text-gray-800">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (page === 'dashboard') {
                loadStats();
                loadTaskStatus();
            } else if (page === 'config') {
                loadConfig();
            } else if (page === 'tasks') {
                loadLastRun();
                loadTaskHistory();
                loadFailedTasks();
            } else if (page === 'prompts') {
                loadPrompts();
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                document.getElementById('total-processed').textContent = data.total_processed || 0;
                document.getElementById('avg-score').textContent = data.avg_score?.toFixed(2) || '0.00';
                document.getElementById('total-spam').textContent = data.total_spam || 0;
                document.getElementById('total-errors').textContent = data.total_errors || 0;
            } catch (e) {
                console.error('Failed to load stats:', e);
                showToast('加载统计失败: ' + e.message, 'error');
                // Set default values on error
                document.getElementById('total-processed').textContent = '-';
                document.getElementById('avg-score').textContent = '-';
                document.getElementById('total-spam').textContent = '-';
                document.getElementById('total-errors').textContent = '-';
            }
        }

        let lastRunPollTimer = null;

        async function loadLastRun() {
            const el = document.getElementById('last-run-detail');
            if (!el) return;
            try {
                const res = await fetch(`${API_BASE}/tasks/status`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const lastRun = data.last_run;
                if (!lastRun) {
                    el.innerHTML = '<p class="text-gray-500">暂无执行记录，手动执行一次任务后这里会显示本次执行过程数据。</p>';
                    return;
                }
                const stats = lastRun.stats || {};
                const startedAt = lastRun.started_at ? formatTime(lastRun.started_at) : '-';
                // 判断任务是否正在执行：只要 lastRun.running = true，无论调度器是否运行，任务都在执行
                const isActuallyRunning = lastRun.running === true;
                
                // 检测任务是否超时（执行超过5分钟且没有进展）
                let isTimeout = false;
                let forceStopButton = '';
                if (isActuallyRunning && lastRun.started_at) {
                    try {
                        const startTime = new Date(lastRun.started_at);
                        const now = new Date();
                        const elapsedMinutes = (now - startTime) / (1000 * 60);
                        // 如果执行超过5分钟，且所有数据都是0，可能是卡住了
                        if (elapsedMinutes > 5 && (stats.emails_found || 0) === 0 && (stats.emails_processed || 0) === 0) {
                            isTimeout = true;
                            forceStopButton = '<button onclick="resetTaskState()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-medium transition">强制停止</button>';
                        }
                    } catch (e) {
                        // 忽略时间解析错误
                    }
                }
                
                let finishedAt;
                if (lastRun.finished_at) {
                    finishedAt = formatTime(lastRun.finished_at);
                } else if (isActuallyRunning) {
                    finishedAt = '执行中...';
                } else {
                    // 已完成但没有 finished_at（可能是旧数据或异常情况）
                    finishedAt = '-';
                }
                let statusText;
                // 优先检查 phase 字段来判断状态
                if (lastRun.phase === "已中断" || lastRun.phase === "已强制重置") {
                    statusText = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-medium">已中断</span>';
                } else if (lastRun.phase === "执行失败") {
                    statusText = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-medium">执行失败</span>';
                } else if (isTimeout) {
                    statusText = '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-medium">可能已卡住</span>';
                } else if (isActuallyRunning) {
                    // 任务正在执行中
                    statusText = '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">执行中</span>';
                } else {
                    // 任务已完成（lastRun.running = false 且 finished_at 有值，或 phase = "已完成"）
                    statusText = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">已完成</span>';
                }
                // 显示 phase 信息：执行中时显示进度，已中断时显示"已中断"，已完成时显示"已完成"
                const phaseHint = (lastRun.phase && isActuallyRunning) ? `<p class="text-sm text-gray-500 mt-1">${escapeHtml(lastRun.phase)}</p>` : '';
                const timeoutWarning = isTimeout ? '<p class="text-sm text-orange-600 mt-2">⚠️ 任务执行时间较长，如果已卡住，请点击"强制停止"</p>' : '';
                el.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><span class="text-gray-500">状态</span><br/><span class="font-medium">${statusText}</span>${phaseHint}${timeoutWarning}${forceStopButton}</div>
                        <div><span class="text-gray-500">开始时间</span><br/><span class="font-medium">${startedAt}</span></div>
                        <div><span class="text-gray-500">结束时间</span><br/><span class="font-medium">${finishedAt}</span></div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="text-gray-700 font-medium mb-2">核心数据</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">发现邮件</span><span class="font-semibold text-gray-900">${stats.emails_found ?? '-'}</span></div>
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">已处理</span><span class="font-semibold text-gray-900">${stats.emails_processed ?? '-'}</span></div>
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">跳过</span><span class="font-semibold text-gray-900">${stats.emails_skipped ?? '-'}</span></div>
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">Gist 创建</span><span class="font-semibold text-gray-900">${stats.gists_created ?? '-'}</span></div>
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">Notion 发布</span><span class="font-semibold text-gray-900">${stats.notion_published ?? '-'}</span></div>
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">本地保存</span><span class="font-semibold text-gray-900">${stats.local_saved ?? '-'}</span></div>
                            <div class="bg-gray-50 rounded-lg px-3 py-2"><span class="text-gray-500 text-xs block">错误数</span><span class="font-semibold ${(stats.errors || 0) > 0 ? 'text-red-600' : 'text-gray-900'}">${stats.errors ?? '-'}</span></div>
                        </div>
                    </div>
                `;
                // 只要本次执行还在进行中就轮询（包括手动执行，此时调度器可能未启动）
                if (lastRun.running) {
                    if (lastRunPollTimer) clearTimeout(lastRunPollTimer);
                    lastRunPollTimer = setTimeout(loadLastRun, 2000);
                } else {
                    if (lastRunPollTimer) { clearTimeout(lastRunPollTimer); lastRunPollTimer = null; }
                }
            } catch (e) {
                console.error('Failed to load last run:', e);
                el.innerHTML = '<p class="text-red-600">加载执行详情失败: ' + (e.message || '未知错误') + '</p>';
            }
        }

        function formatTime(iso) {
            if (!iso) return '-';
            try {
                const d = new Date(iso);
                return isNaN(d.getTime()) ? iso : d.toLocaleString('zh-CN');
            } catch (_) { return iso; }
        }

        async function loadTaskStatus() {
            try {
                const res = await fetch(`${API_BASE}/tasks/status`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const statusEl = document.getElementById('task-status');
                const pauseBtn = document.getElementById('pause-task-btn');
                const resumeBtn = document.getElementById('resume-task-btn');
                const startBtn = document.getElementById('start-scheduler-btn');
                const schedulerInfoEl = document.getElementById('scheduler-status-info');
                
                // 优先显示任务执行状态，如果没有执行中的任务，再显示调度器状态
                const lastRun = data.last_run;
                let taskStatusHtml = '';
                
                if (lastRun && lastRun.running === true) {
                    // 有任务正在执行
                    if (lastRun.phase === "已中断" || lastRun.phase === "已强制重置") {
                        taskStatusHtml = '<span class="status-badge" style="background-color: #fbbf24; color: #78350f;">已中断</span>';
                    } else if (lastRun.phase === "执行失败") {
                        taskStatusHtml = '<span class="status-badge" style="background-color: #fee2e2; color: #991b1b;">执行失败</span>';
                    } else {
                        taskStatusHtml = '<span class="status-badge status-running">执行中</span>';
                    }
                } else {
                    // 没有任务在执行，显示调度器状态
                    if (data.running) {
                        if (data.paused) {
                            taskStatusHtml = '<span class="status-badge" style="background-color: #fbbf24; color: #78350f;">已暂停</span>';
                        } else {
                            taskStatusHtml = '<span class="status-badge status-running">运行中</span>';
                        }
                    } else {
                        taskStatusHtml = '<span class="status-badge status-stopped">已停止</span>';
                    }
                }
                
                statusEl.innerHTML = taskStatusHtml;
                
                // 更新按钮显示（基于调度器状态）
                if (data.running) {
                    if (data.paused) {
                        if (pauseBtn) pauseBtn.classList.add('hidden');
                        if (resumeBtn) resumeBtn.classList.remove('hidden');
                        if (startBtn) startBtn.classList.add('hidden');
                        if (schedulerInfoEl) {
                            const nextRun = data.next_run_time ? formatTime(data.next_run_time) : '已暂停';
                            schedulerInfoEl.innerHTML = `<p>状态：<span class="font-medium text-yellow-600">已暂停</span></p><p>间隔：${data.interval_minutes || '-'} 分钟</p><p>下次执行：${nextRun}</p>`;
                        }
                    } else {
                        if (pauseBtn) pauseBtn.classList.remove('hidden');
                        if (resumeBtn) resumeBtn.classList.add('hidden');
                        if (startBtn) startBtn.classList.add('hidden');
                        if (schedulerInfoEl) {
                            const nextRun = data.next_run_time ? formatTime(data.next_run_time) : '计算中...';
                            schedulerInfoEl.innerHTML = `<p>状态：<span class="font-medium text-green-600">运行中</span></p><p>间隔：${data.interval_minutes || '-'} 分钟</p><p>下次执行：${nextRun}</p>`;
                        }
                    }
                } else {
                    if (pauseBtn) pauseBtn.classList.add('hidden');
                    if (resumeBtn) resumeBtn.classList.add('hidden');
                    if (startBtn) startBtn.classList.remove('hidden');
                    if (schedulerInfoEl) {
                        schedulerInfoEl.innerHTML = `<p>状态：<span class="font-medium text-gray-600">未启动</span></p><p>间隔：${data.interval_minutes || '-'} 分钟</p><p>下次执行：-</p>`;
                    }
                }
            } catch (e) {
                console.error('Failed to load task status:', e);
                const statusEl = document.getElementById('task-status');
                const pauseBtn = document.getElementById('pause-task-btn');
                const resumeBtn = document.getElementById('resume-task-btn');
                const startBtn = document.getElementById('start-scheduler-btn');
                if (statusEl) statusEl.textContent = '加载失败';
                // Hide buttons on error to avoid confusion
                if (pauseBtn) pauseBtn.classList.add('hidden');
                if (resumeBtn) resumeBtn.classList.add('hidden');
                if (startBtn) startBtn.classList.add('hidden');
            }
        }

        async function startScheduler() {
            showConfirm('启动调度', `确定要启动定时任务调度吗？将每 ${document.getElementById('scheduler-status-info')?.textContent.match(/间隔：(\d+)/)?.[1] || '?'} 分钟自动执行一次。`, '启动', async () => {
                try {
                    const res = await fetch(`${API_BASE}/tasks/start`, {method: 'POST'});
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    if (data.success) {
                        showToast('调度器已启动', 'success');
                        loadTaskStatus();
                    } else {
                        showToast('启动失败: ' + (data.error || '未知错误'), 'error');
                    }
                } catch (e) {
                    showToast('启动失败: ' + (e.message || '未知错误'), 'error');
                }
            });
        }

        async function pauseTask() {
            showConfirm('暂停调度', '确定要暂停定时任务调度吗？暂停后不会自动处理邮件，但可以手动执行。', '暂停', async () => {
                try {
                    const res = await fetch(`${API_BASE}/tasks/pause`, {method: 'POST'});
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    if (data.success) {
                        showToast('调度器已暂停', 'success');
                        loadTaskStatus();
                    } else {
                        showToast('暂停失败: ' + (data.error || '未知错误'), 'error');
                    }
                } catch (e) {
                    showToast('暂停失败: ' + (e.message || '未知错误'), 'error');
                }
            });
        }

        async function resumeTask() {
            try {
                const res = await fetch(`${API_BASE}/tasks/resume`, {method: 'POST'});
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                const data = await res.json();
                if (data.success) {
                    showToast('调度器已恢复', 'success');
                    loadTaskStatus();
                } else {
                    showToast('恢复失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('恢复失败: ' + (e.message || '未知错误'), 'error');
            }
        }

        async function stopTask() {
            showConfirm('停止调度', '确定要停止定时任务调度吗？停止后需要重启容器才能恢复。', '停止', async () => {
                try {
                    const res = await fetch(`${API_BASE}/tasks/stop`, {method: 'POST'});
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    if (data.success) {
                        showToast('调度器已停止', 'success');
                        loadTaskStatus();
                    } else {
                        showToast('停止失败: ' + (data.error || '未知错误'), 'error');
                    }
                } catch (e) {
                    showToast('停止失败: ' + (e.message || '未知错误'), 'error');
                }
            });
        }

        async function loadPrompts() {
            try {
                const res = await fetch(`${API_BASE}/prompts`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                document.getElementById('system-prompt').value = data.system_prompt || '';
                document.getElementById('user-prompt').value = data.user_prompt_template || '';
            } catch (e) {
                showToast('加载 Prompt 失败: ' + e.message, 'error');
            }
        }

        async function savePrompts() {
            try {
                const res = await fetch(`${API_BASE}/prompts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        system_prompt: document.getElementById('system-prompt').value,
                        user_prompt_template: document.getElementById('user-prompt').value,
                    }),
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Prompt 已保存并重载', 'success');
                } else {
                    showToast('保存失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('保存 Prompt 失败: ' + e.message, 'error');
            }
        }

        async function reloadPrompts() {
            try {
                const res = await fetch(`${API_BASE}/prompts/reload`, {method: 'POST'});
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (data.success) {
                    showToast('Prompt 已重新加载', 'success');
                } else {
                    showToast('重载失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('重载 Prompt 失败: ' + e.message, 'error');
            }
        }

        async function testPrompt() {
            const content = document.getElementById('test-content').value.trim();
            if (!content) {
                showToast('请输入测试内容', 'error');
                return;
            }

            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.add('hidden');
            resultDiv.querySelector('pre').textContent = '测试中...';

            try {
                const res = await fetch(`${API_BASE}/prompts/test`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        content: content,
                        sender: 'Test Sender',
                        subject: 'Test Subject',
                        date: new Date().toISOString(),
                    }),
                });
                const data = await res.json();
                const pre = resultDiv.querySelector('pre');
                if (data.success && data.gist) {
                    pre.textContent = JSON.stringify(data.gist, null, 2);
                    resultDiv.classList.remove('hidden');
                    showToast('测试成功', 'success');
                } else {
                    showToast('测试失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('测试 Prompt 失败: ' + e.message, 'error');
            }
        }

        async function runTask() {
            showConfirm('手动执行任务', '确定要手动执行一次任务吗？', '执行', () => {
                executeRunTask();
            });
        }
        
        async function executeRunTask() {
            try {
                const res = await fetch(`${API_BASE}/tasks/run`, {method: 'POST'});
                if (!res.ok) {
                    if (res.status === 409) {
                        // 任务正在执行中，提供重置选项
                        const data = await res.json().catch(() => ({}));
                        showConfirm('任务正在执行', '检测到任务可能正在执行中。如果任务已卡住，可以强制重置状态。', '强制重置', async () => {
                            await resetTaskState();
                        });
                        return;
                    }
                    throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || '任务已启动，正在后台执行', 'success');
                    loadTaskStatus();
                    loadLastRun();
                    // loadLastRun 内部会按 lastRun.running 决定是否 2s 后再轮询，此处无需 setInterval
                } else {
                    showToast('启动失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('启动任务失败: ' + e.message, 'error');
            }
        }

        async function resetTaskState() {
            try {
                const res = await fetch(`${API_BASE}/tasks/reset`, {method: 'POST'});
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                const data = await res.json();
                if (data.success) {
                    showToast('任务状态已重置', 'success');
                    loadTaskStatus();
                    loadLastRun();
                } else {
                    showToast('重置失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('重置任务状态失败: ' + e.message, 'error');
            }
        }

        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            const currentValue = input.value;
            
            // If value is masked and user wants to see it, show placeholder
            if (currentValue.startsWith('****') && input.type === 'password') {
                input.type = 'text';
                input.value = '';  // Clear masked value
                input.placeholder = '点击显示密码（需要重新输入）';
                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>`;
            } else if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>`;
            } else {
                input.type = 'password';
                if (input.placeholder) {
                    input.placeholder = '';
                }
                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
            }
        }

        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/config`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const responseData = await res.json();
                const data = responseData.config || responseData;
                const hasEnvFile = responseData.has_env_file !== false;
                
                // 显示 .env 文件状态
                let statusHtml = '';
                if (!hasEnvFile) {
                    statusHtml = '<div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="text-sm text-yellow-800">⚠️ .env 文件不存在，已自动创建。请填写配置后保存。</p></div>';
                }
                
                // 必选配置
                const required = {
                    'Gmail 配置': ['GMAIL_USER', 'GMAIL_APP_PASSWORD', 'TARGET_LABEL'],
                    'LLM 配置': ['OPENAI_API_KEY', 'OPENAI_BASE_URL', 'LLM_MODEL_NAME'],
                    'Notion 配置': ['NOTION_API_KEY', 'NOTION_DATABASE_ID'],
                };
                
                // 可选配置
                const optional = {
                    'Gmail 高级': ['GMAIL_FOLDER'],
                    'LLM 参数': ['LLM_TEMPERATURE', 'LLM_MAX_TOKENS'],
                    '本地存储': ['ENABLE_LOCAL_STORAGE', 'LOCAL_STORAGE_PATH', 'LOCAL_STORAGE_FORMAT'],
                    '系统设置': ['LOG_LEVEL', 'CHECK_INTERVAL_MINUTES', 'MAX_EMAILS_PER_RUN'],
                    '内容处理': ['MAX_CONTENT_LENGTH', 'CONTENT_TRUNCATION_HEAD', 'CONTENT_TRUNCATION_TAIL'],
                    '重试设置': ['LLM_MAX_RETRIES', 'LLM_RETRY_DELAY_SECONDS'],
                    'Prompt 路径': ['PROMPT_SYSTEM_PATH', 'PROMPT_USER_PATH'],
                    'Web 服务器': ['WEB_SERVER_PORT', 'WEB_SERVER_HOST'],
                };

                let html = statusHtml + '<div class="mb-6"><h3 class="text-base font-semibold text-red-600 mb-3 flex items-center"><span class="w-1 h-5 bg-red-600 mr-2 rounded"></span>必选配置</h3>';
                for (const [groupName, keys] of Object.entries(required)) {
                    html += `<div class="config-required rounded-lg p-4 mb-3"><h4 class="font-medium text-gray-800 mb-3 text-sm">${groupName}</h4><div class="space-y-3">`;
                    for (const key of keys) {
                        if (data[key] !== undefined) {
                            const value = data[key];
                            const isPassword = key.includes('PASSWORD') || key.includes('API_KEY');
                            if (isPassword) {
                                html += `<div class="flex items-center">
                                    <label class="w-48 text-sm font-medium text-gray-700">${key}:</label>
                                    <div class="flex-1 relative">
                                        <input type="password" id="config-${key}" value="${value}" class="w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                        <button type="button" onclick="togglePasswordVisibility('config-${key}', 'eye-${key}')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="eye-${key}">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        </button>
                                    </div>
                                </div>`;
                            } else {
                                html += `<div class="flex items-center">
                                    <label class="w-48 text-sm font-medium text-gray-700">${key}:</label>
                                    <input type="text" id="config-${key}" value="${value}" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                </div>`;
                            }
                        }
                    }
                    html += '</div></div>';
                }
                html += '</div>';

                html += '<div><h3 class="text-base font-semibold text-gray-600 mb-3 flex items-center"><span class="w-1 h-5 bg-gray-400 mr-2 rounded"></span>可选配置</h3>';
                for (const [groupName, keys] of Object.entries(optional)) {
                    html += `<details class="config-optional rounded-lg p-4 mb-2"><summary class="font-medium text-gray-700 cursor-pointer mb-2 text-sm hover:text-gray-900">${groupName}</summary><div class="space-y-3 mt-3">`;
                    for (const key of keys) {
                        if (data[key] !== undefined) {
                            const value = data[key];
                            const isPassword = key.includes('PASSWORD') || key.includes('API_KEY');
                            const inputType = isPassword ? 'password' : (typeof value === 'boolean' ? 'checkbox' : 'text');
                            if (inputType === 'checkbox') {
                                html += `<div class="flex items-center">
                                    <label class="w-48 text-sm font-medium text-gray-600">${key}:</label>
                                    <input type="checkbox" id="config-${key}" ${value ? 'checked' : ''} class="border-gray-300 rounded">
                                </div>`;
                            } else if (isPassword) {
                                html += `<div class="flex items-center">
                                    <label class="w-48 text-sm font-medium text-gray-600">${key}:</label>
                                    <div class="flex-1 relative">
                                        <input type="password" id="config-${key}" value="${value}" class="w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 text-sm focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
                                        <button type="button" onclick="togglePasswordVisibility('config-${key}', 'eye-${key}')" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="eye-${key}">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        </button>
                                    </div>
                                </div>`;
                            } else {
                                html += `<div class="flex items-center">
                                    <label class="w-48 text-sm font-medium text-gray-600">${key}:</label>
                                    <input type="text" id="config-${key}" value="${value}" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
                                </div>`;
                            }
                        }
                    }
                    html += '</div></details>';
                }
                html += '</div>';

                document.getElementById('config-form').innerHTML = html;
            } catch (e) {
                document.getElementById('config-form').innerHTML = '<p class="text-red-600">加载失败: ' + e.message + '</p>';
            }
        }

        async function saveConfig() {
            try {
                const inputs = document.querySelectorAll('#config-form input');
                const config = {};
                inputs.forEach(input => {
                    const key = input.id.replace('config-', '');
                    if (input.type === 'checkbox') {
                        config[key] = input.checked;
                    } else {
                        // For password fields, if value is still masked (starts with ****), skip it
                        const value = input.value;
                        if (input.type === 'password' && value.startsWith('****')) {
                            // Skip masked passwords - they haven't been changed
                            return;
                        }
                        config[key] = value;
                    }
                });

                const res = await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config),
                });
                const data = await res.json();
                if (data.success) {
                    showToast('配置已保存', 'success');
                    loadConfig();
                } else {
                    showToast('保存失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('保存配置失败: ' + e.message, 'error');
            }
        }

        async function loadTaskHistory() {
            try {
                const res = await fetch(`${API_BASE}/tasks/history`);
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                const data = await res.json();
                const history = data.history || [];
                
                if (history.length === 0) {
                    document.getElementById('task-history').innerHTML = '<p class="text-gray-500 text-center py-8">暂无历史记录</p>';
                    return;
                }

                const html = `<div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">主题</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">发件人</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">评分</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">处理时间</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">状态</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${history.map(h => {
                                const processedAt = h.processed_at ? (typeof h.processed_at === 'string' ? h.processed_at : new Date(h.processed_at).toLocaleString('zh-CN')) : '-';
                                const score = h.score !== null && h.score !== undefined ? h.score : '-';
                                return `
                                <tr class="table-row">
                                    <td class="px-4 py-3 text-sm text-gray-900">${escapeHtml(h.subject || h.message_id || '-')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(h.sender || '-')}</td>
                                    <td class="px-4 py-3 text-sm"><span class="font-medium ${score !== '-' && score >= 80 ? 'text-green-600' : score !== '-' && score >= 60 ? 'text-blue-600' : 'text-gray-600'}">${score}</span></td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${processedAt}</td>
                                    <td class="px-4 py-3 text-sm">
                                        ${h.is_spam ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">垃圾</span>' : '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">正常</span>'}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <button type="button" data-message-id="${escapeHtml(h.message_id || '')}" onclick="reprocessTask(this.dataset.messageId)" class="text-blue-600 hover:text-blue-800 text-xs font-medium transition" title="下次运行将重新拉取并处理">重新处理</button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
                document.getElementById('task-history').innerHTML = html;
            } catch (e) {
                console.error('Failed to load task history:', e);
                document.getElementById('task-history').innerHTML = '<p class="text-red-600 text-center py-8">加载失败: ' + escapeHtml(e.message) + '</p>';
                showToast('加载任务历史失败: ' + e.message, 'error');
            }
        }

        async function loadFailedTasks() {
            try {
                const errorsRes = await fetch(`${API_BASE}/tasks/errors`);
                if (!errorsRes.ok) {
                    const errorData = await errorsRes.json().catch(() => ({}));
                    if (errorsRes.status === 503) {
                        document.getElementById('failed-tasks').innerHTML = '<p class="text-yellow-600 text-center py-8">服务不可用，请稍后重试</p>';
                        return;
                    }
                    throw new Error(errorData.error || `HTTP ${errorsRes.status}`);
                }
                const errorsData = await errorsRes.json();
                const errors = errorsData.errors || [];

                if (errors.length === 0) {
                    document.getElementById('failed-tasks').innerHTML = '<p class="text-gray-500 text-center py-8">暂无失败任务</p>';
                    return;
                }

                const html = `<div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Message ID</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">错误信息</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">错误时间</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${errors.map(e => {
                                const errorTime = e.error_time ? (typeof e.error_time === 'string' ? e.error_time : new Date(e.error_time).toLocaleString('zh-CN')) : '-';
                                const messageId = e.message_id || '-';
                                return `
                                <tr class="table-row">
                                    <td class="px-4 py-3 text-sm text-gray-900 font-mono text-xs">${escapeHtml(messageId)}</td>
                                    <td class="px-4 py-3 text-sm text-red-600 max-w-md truncate" title="${escapeHtml(e.error_message || '-')}">${escapeHtml(e.error_message || '-')}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${errorTime}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <button onclick="retryTask('${escapeHtml(messageId)}')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 text-xs font-medium transition">
                                            重试
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
                document.getElementById('failed-tasks').innerHTML = html;
            } catch (e) {
                console.error('Failed to load failed tasks:', e);
                document.getElementById('failed-tasks').innerHTML = '<p class="text-red-600 text-center py-8">加载失败: ' + escapeHtml(e.message) + '</p>';
                showToast('加载失败任务失败: ' + e.message, 'error');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function retryTask(messageId) {
            showConfirm('重试任务', '确定要重试这个任务吗？', '重试', () => {
                executeRetryTask(messageId);
            });
        }

        function reprocessTask(messageId) {
            if (!messageId) {
                showToast('无法重新处理：缺少 message_id', 'error');
                return;
            }
            showConfirm('重新处理', '将从处理记录中移除该条，下次定时运行时会重新拉取并处理该邮件。确定继续？', '确定', () => {
                executeReprocessTask(messageId);
            });
        }

        async function executeReprocessTask(messageId) {
            try {
                const res = await fetch(`${API_BASE}/tasks/reprocess`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message_id: messageId}),
                });
                const data = await res.json();
                if (data.success) {
                    showToast('已标记重新处理', 'success');
                    loadTaskHistory();
                } else {
                    showToast('操作失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('请求失败: ' + e.message, 'error');
            }
        }
        
        async function executeRetryTask(messageId) {
            try {
                const res = await fetch(`${API_BASE}/tasks/retry`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message_id: messageId}),
                });
                const data = await res.json();
                if (data.success) {
                    showToast('重试任务已提交', 'success');
                    loadFailedTasks();
                } else {
                    showToast('重试失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('重试任务失败: ' + e.message, 'error');
            }
        }

        async function loadPromptHistory() {
            try {
                const type = document.getElementById('prompt-history-type').value;
                const res = await fetch(`${API_BASE}/prompts/history${type ? '?type=' + type : ''}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const history = data.history || [];
                
                if (history.length === 0) {
                    document.getElementById('prompt-history-list').innerHTML = '<p class="text-gray-500 text-center py-4">暂无历史记录</p>';
                    return;
                }

                const html = history.map(h => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-gray-300 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-medium">${h.prompt_type}</span>
                                <span class="text-xs text-gray-500">${h.created_at}</span>
                            </div>
                            <button onclick="restorePrompt(${h.id})" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 text-xs font-medium transition">
                                恢复
                            </button>
                        </div>
                        <pre class="text-xs bg-gray-50 p-3 rounded mt-2 overflow-x-auto border border-gray-100">${escapeHtml(h.content.substring(0, 200))}${h.content.length > 200 ? '...' : ''}</pre>
                    </div>
                `).join('');
                document.getElementById('prompt-history-list').innerHTML = html;
            } catch (e) {
                document.getElementById('prompt-history-list').innerHTML = '<p class="text-red-600">加载失败: ' + e.message + '</p>';
            }
        }

        async function restorePrompt(versionId) {
            showConfirm('恢复 Prompt', '确定要恢复这个版本的 Prompt 吗？当前 Prompt 将被替换。', '恢复', () => {
                executeRestorePrompt(versionId);
            });
        }
        
        async function executeRestorePrompt(versionId) {
            try {
                const res = await fetch(`${API_BASE}/prompts/restore`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({version_id: versionId}),
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Prompt 已恢复', 'success');
                    loadPrompts();
                    loadPromptHistory();
                } else {
                    showToast('恢复失败: ' + (data.error || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('恢复 Prompt 失败: ' + e.message, 'error');
            }
        }

        // Load on page load
        window.addEventListener('load', () => {
            loadPrompts();
            loadStats();
            loadTaskStatus();
        });
    </script>
</body>
</html>
